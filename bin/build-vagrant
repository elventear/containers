#!/bin/bash
# Copyright (c) 2015 RadiaSoft LLC.  All Rights Reserved.
#
# Build the Fedora 21 VM and create package.box.
#
cd $(dirname "$0")

test -d ../vagrant && (cd ../vagrant; vagrant destroy -f) &> /dev/null

base_box=hansode/fedora-21-server-x86_64

# Standard network for us so it always should be vboxnet0
# Only needed for $BIVIO_GIT_SERVER.
build_container_net=10.10.10
. ../libexec/build-setup.sh

box=radiasoft/fedora
if vagrant box list | grep -s -q "$box"; then
    # If there is a VM running or dependent on it, will get an error
    vagrant box remove "$box"
fi

if [[ $BIVIO_GIT_SERVER ]]; then
    # Must be different than install-user.sh (so can run two VMs simultaneously)
    # Shouldn't collide with existing uses (1-60) either. Only important for
    # the build if there is a git server
    declare -i i=$(perl -e 'print(int(rand(50)) + 60)')
    ip=
    while (( $i < 255 )); do
        x=$build_container_net.$i
        if ! ( echo > /dev/tcp/$x/22 ) >& /dev/null; then
            ip=$x
            break
        fi
        i+=1
    done
    if [[ ! $ip ]]; then
        echo "Unable to find a free IP address on $build_container_net" 1>&2
        exit 1
    fi
    private_net="config.vm.network \"private_network\", ip: \"$ip\""
fi

cat > Vagrantfile <<EOF
Vagrant.configure(2) do |config|
  config.vm.box = "$base_box"
  $private_net
end
EOF
vagrant up

shopt -s nullglob

find *.*[a-z] ! -type d | cpio -o | vagrant ssh -c "sudo bash -c 'mkdir /cfg; cd /cfg; cpio -i'"

# This will update the virtualbox additions if necessary
bivio_vagrant_ssh 'sudo bash /cfg/build-linux.sh'
vagrant halt
vagrant package --output package.box
vagrant box add "$box" package.box
# Need to destroy VM because directory is emphemeral
vagrant destroy -f
rm -rf Vagrantfile .vagrant.d
echo 'See README.md to upload'
