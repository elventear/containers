#!/bin/bash
# Copyright (c) 2015 RadiaSoft LLC.  All Rights Reserved.
#
# Sets up the environment to run Docker
#

cd $(dirname "$0")

# Docker's hardwired container network (only needed if $BIVIO_GIT_SERVER running)
build_container_net=172.17.42
. ../libexec/build-setup.sh

image=radiasoft/fedora
if docker images | grep -s -q "$image"; then
    #TODO(robnagler) is this safe?
    # Remove none running containers.
    for f in $(docker ps -a | perl -n -e "m{^(\w+)\s.*\s\Q$image\E[\s:]} && print(qq{\$1\n})"); do
        docker rm $f
    done
    docker rmi "$image"
fi

rm -f Dockerfile
cat > Dockerfile <<'EOF'
FROM fedora:21
MAINTAINER RadiaSoft <docker@radiasoft.net>
ADD . /cfg
RUN sh /cfg/build-linux.sh
EOF

docker build --rm=true --tag="$image" .
